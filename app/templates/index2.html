<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
        <title>Where is my car?</title>
        <style>
            html,
            body,
            #viewDiv {
                padding: 0;
                margin: 0;
                height: 100%;
                width: 100%;
            }

            @keyframes flash {
                0%, 100% {
                    background-color: transparent;
                }
                50% {
                    background-color: yellow;
                }
            }

            .esri-locate {
                animation: flash 2s;
                animation-iteration-count: 5;
            }
            
        </style>
        <link rel="stylesheet" href="https://js.arcgis.com/4.27/esri/themes/light/main.css" />
        <script src="https://js.arcgis.com/4.27/"></script>
        <script>

            require([
                "esri/config",
                "esri/Map",
                "esri/views/MapView",
                "esri/widgets/Locate",
                "esri/widgets/Search",

                "esri/rest/locator"

            ], function (esriConfig, Map, MapView, Locate, Search, locator) {

                esriConfig.apiKey = "{{arcgis_key}}";

                const map = new Map({
                    basemap: "arcgis-navigation"
                });

                const view = new MapView({
                    container: "viewDiv",
                    map: map,
                    center: [-74.034775,40.745255],
                    zoom: 15
                });

                const locate = new Locate({
                    view: view,
                    useHeadingEnabled: false,
                    goToOverride: function(view, options) {
                        options.target.scale = 1500;
                        return view.goTo(options.target);
                    }
                });

                view.ui.add(locate, "top-left");
                
                // Initialize popup
                const infoPopup = document.getElementById("infoPopup");
                infoPopup.innerHTML = "Press this button to find your current location";
                infoPopup.style.display = "block";

                // Display popup when MapView is ready
                view.when(function() {
                    infoPopup.style.display = "block";
                });

                const serviceUrl = "http://geocode-api.arcgis.com/arcgis/rest/services/World/GeocodeServer";

                function handleClick(evt) {
                    infoPopup.style.display = "none"; // Hide popup

                    const params = {
                        location: evt.mapPoint
                    };

                    locator.locationToAddress(serviceUrl, params).then(
                        function (response) {
                            const address = response.address;
                            showAddress(address, evt.mapPoint);
                        },
                        function (err) {
                            showAddress("No address found.", evt.mapPoint);
                        }
                    );
                }


                function showAddress(address, pt) { //Show reverse geocoded address on map
                    view.openPopup({
                        title: "Address Selected",
                        content: address,
                        location: pt,
                        actions: [],
                        dockEnabled: false,
                        visible: false
                    });
                }
                
                view.on("click", handleClick);

                const search = new Search({  //Add Search widget
                    view: view
                });

                view.ui.add(search, "top-right"); //Add to the map

            });
        </script>
    </head>
    <body>
        <div id="viewDiv"></div>
        <div id="infoPopup" style="position: absolute; top: 90px; left: 55px; display: none; background-color: rgba(255, 255, 0, 0.3); color: black; padding: 1px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            Press this button to find your current location
        </div>
    </body>
</html>